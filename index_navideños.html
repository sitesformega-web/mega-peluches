<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NavideÃ±os</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f9f9f9; }
h1 { text-align:center; margin-bottom:30px; }
#loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9);
Â  display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2000; color:#293073; font-size:18px; font-weight:bold; }
#loader-overlay .punto { width:25px; height:25px; background:#293073; border-radius:50%; margin-bottom:15px; animation:pulso 1s infinite ease-in-out; }
@keyframes pulso { 0%,100%{transform:scale(1);opacity:0.6;} 50%{transform:scale(1.6);opacity:1;} }
.acordeon { margin-bottom:20px; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
.acordeon-titulo { background:#293073; color:white; padding:15px; font-size:18px; cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
.acordeon-titulo:hover { background:#1f2557; }
.acordeon-contenido { display:none; padding:20px; background:white; }
.grid { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
.card { background:white; border-radius:10px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.15); display:flex; flex-direction:column; }
.card img { width:100%; min-height:200px; object-fit:contain; border-radius:8px; margin-bottom:10px; background:#f0f0f0; }
.info h2 { font-size:18px; margin:5px 0; }
.info p { margin:3px 0; font-size:14px; color:#555; }
.prices strong { display:block; }
.actions { display:flex; justify-content:space-between; align-items:center; margin-top:10px; }
.actions input { width:60px; padding:5px; text-align:center; }
.btn { background:#25d366; color:white; padding:8px 12px; border:none; border-radius:6px; text-decoration:none; font-size:14px; cursor:pointer; transition:0.3s; }
.btn:hover { background:#1ebe5d; }
.btn.agregado { background:#aaa; cursor:default; }
#mini-carrito { background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); margin-top:30px; }
#mini-carrito h2 { margin-top:0; margin-bottom:10px; }
#mini-carrito ul { list-style:none; padding:0; margin:0; }
#mini-carrito li { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
#mini-carrito li input { width:50px; padding:3px; margin-left:10px; text-align:center; }
.eliminar-btn { margin-left:10px; background:#ff4d4d; color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; }
.eliminar-btn:hover { background:#e60000; }
#enviar-whatsapp { display:block; margin-top:15px; text-align:center; }
#boton-carrito { position:fixed; bottom:20px; right:20px; background:#25d366; color:white; border:none; border-radius:50px;
Â  padding:12px 20px; font-size:16px; box-shadow:0 4px 10px rgba(0,0,0,0.25); cursor:pointer; z-index:1000; display:none; }
#boton-carrito:hover { background:#1ebe5d; }
#contador-carrito { background:#ff3b3b; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:8px; }
@media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr);} }
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr);} }
@media(max-width:600px){
Â  .grid{grid-template-columns:1fr;}
Â  #mini-carrito li{flex-direction:column;align-items:flex-start;}
Â  #mini-carrito li input{margin-left:0;margin-top:5px;}
Â  .eliminar-btn{margin-left:0;margin-top:5px;}
Â  #enviar-whatsapp{width:100%;}
Â  #boton-carrito{padding:10px 16px;font-size:14px;bottom:15px;right:15px;}
}
</style>
</head>
<body>
<h1>NavideÃ±os</h1>

<div id="loader-overlay">
Â  <div class="punto"></div>
Â  <p>Cargando contenido...</p>
</div>

<div id="acordeones-container"></div>

<div id="mini-carrito">
Â  <h2>Tu carrito</h2>
Â  <ul id="lista-carrito"></ul>
Â  <a id="enviar-whatsapp" class="btn" target="_blank">Enviar pedido por WhatsApp</a>
</div>

<button id="boton-carrito">ðŸ›’ Ver carrito <span id="contador-carrito">0</span></button>

<script>
let carrito = [];
// ðŸ’¡ MODIFICACIÃ“N 1: Establecer el nÃºmero por defecto y buscar el parÃ¡metro de URL.
let whatsappVendedorAsignado = "595986830888"; // NÃºmero por defecto/fallback
const urlParams = new URLSearchParams(window.location.search);
const vendedorParam = urlParams.get('vendedor');

// URL de productos (con el ID de tu Apps Script)
let urlProductos = "https://script.google.com/macros/s/AKfycbxrpqH6Nzs-0Kkb-VUXOvrWaogYYpF_oR8JCywKPAcTSreeZ6kFeqh93Bz18b19YmcG0Q/exec?sheet=NavideÃ±os";

// ðŸ’¡ MODIFICACIÃ“N 2: AÃ±adir el parÃ¡metro del vendedor a la URL si existe.
if (vendedorParam) {
    urlProductos += `&vendedor=${encodeURIComponent(vendedorParam)}`;
}

// ðŸ”¹ FunciÃ³n para obtener precio
function obtenerPrecio(cantidad, precioMinorista, precioMayorista){
Â  return cantidad >= 6 ? parseInt(precioMayorista) : parseInt(precioMinorista);
}

// ðŸ”¹ Actualizar carrito
function actualizarCarrito() {
Â  const lista = document.getElementById("lista-carrito");
Â  const contador = document.getElementById("contador-carrito");
Â  const botonFlotante = document.getElementById("boton-carrito");
Â  lista.innerHTML = "";
Â  let total = 0;
Â  carrito.forEach(item => {
Â  Â  const li = document.createElement("li");
Â  Â  // Aseguramos que el producto en el carrito siempre tenga el WhatsApp del vendedor final (aunque no lo necesite en el envÃ­o)
Â  Â  // Pero lo dejamos como estaba, el envÃ­o ya usa la variable global.
Â  Â  li.innerHTML = `
Â  Â  Â  <span>${item.nombre} (cÃ³d: ${item.codigo}) - Gs. ${item.subtotal.toLocaleString()}</span>
Â  Â  Â  <input type="number" min="1" value="${item.cantidad}" data-codigo="${item.codigo}" />
Â  Â  Â  <button class="eliminar-btn" data-codigo="${item.codigo}">Eliminar</button>`;
Â  Â  lista.appendChild(li);
Â  Â  total += item.subtotal;
Â  });
Â  const totalLi = document.createElement("li");
Â  totalLi.style.fontWeight = "bold";
Â  totalLi.textContent = `Total: Gs. ${total.toLocaleString()}`;
Â  lista.appendChild(totalLi);
Â  if(carrito.length > 0){
Â  Â  botonFlotante.style.display = "flex";
Â  Â  contador.textContent = carrito.length;
Â  } else {
Â  Â  botonFlotante.style.display = "none";
Â  }
}

// ðŸ”¹ Enviar pedido por WhatsApp
document.getElementById("enviar-whatsapp").addEventListener("click", e => {
Â  e.preventDefault();
Â  if(carrito.length === 0) return alert("El carrito estÃ¡ vacÃ­o");

Â  // ðŸ’¡ MODIFICACIÃ“N 3: Eliminar la lÃ³gica de agrupar por vendedor y usar la variable global.
Â  // El nÃºmero de WhatsApp serÃ¡ el que se haya determinado en la carga de datos.
Â  const vendedorFinal = whatsappVendedorAsignado; 

Â  const items = carrito;
Â  const mensaje = items.map(i=>`${i.nombre} (cÃ³d:${i.codigo}) - Cantidad: ${i.cantidad} - Gs. ${i.subtotal.toLocaleString()}`).join("%0A");
Â  const total = items.reduce((acc,i)=>acc+i.subtotal,0);
Â  const texto = `Hola! Quiero:%0A${mensaje}%0ATotal: Gs. ${total.toLocaleString()}`;
Â  
Â  // Abrir UNA SOLA ventana con el vendedor asignado
Â  const link = `https://wa.me/${vendedorFinal}?text=${texto}`;
Â  window.open(link,"_blank");
});

// ðŸ”¹ BotÃ³n flotante
document.getElementById("boton-carrito").addEventListener("click",()=>{
Â  document.getElementById("mini-carrito").scrollIntoView({behavior:"smooth"});
});

// ðŸ”¹ Cargar productos
fetch(urlProductos)
Â  .then(res=>res.json())
Â  .then(data=>{
    // ðŸ’¡ MODIFICACIÃ“N 4: Capturar el nÃºmero de WhatsApp si Apps Script lo devolviÃ³.
    if (data.telefonoVendedor) {
      whatsappVendedorAsignado = data.telefonoVendedor;
    }

Â  Â  document.getElementById("loader-overlay").style.display = "none";
Â  Â  document.getElementById("acordeones-container").style.display = "block";
Â  Â  const container = document.getElementById("acordeones-container");
    
    // Asumimos que data.hojas contiene el catÃ¡logo, ignorando la hoja de 'vendedores'.
    const todosLosProductos = data.hojas
        .filter(s => s.nombreHoja?.toLowerCase() !== 'vendedores')
        .flatMap(h => h.datos);

Â  Â  const grupos = {};
Â  Â  todosLosProductos.forEach(item=>{
Â  Â  Â  const etiqueta = (item["Etiqueta"]||"Sin CategorÃ­a").trim();
Â  Â  Â  if(!grupos[etiqueta]) grupos[etiqueta] = [];
Â  Â  Â  grupos[etiqueta].push(item);
Â  Â  });

Â  Â  Object.keys(grupos).forEach(etiqueta=>{
Â  Â  Â  const acordeon = document.createElement("div");
Â  Â  Â  acordeon.className = "acordeon";
Â  Â  Â  const titulo = document.createElement("div");
Â  Â  Â  titulo.className = "acordeon-titulo";
Â  Â  Â  titulo.innerHTML = `${etiqueta} <span>+</span>`;
Â  Â  Â  const contenido = document.createElement("div");
Â  Â  Â  contenido.className = "acordeon-contenido";
Â  Â  Â  const grid = document.createElement("div");
Â  Â  Â  grid.className = "grid";

Â  Â  Â  grupos[etiqueta].forEach(item=>{
Â  Â  Â  Â  const nombre = (item["Nombre del producto"]||"").trim();
Â  Â  Â  Â  const detalle = (item["Detalle"]||"").trim();
Â  Â  Â  Â  const codigo = (item["CÃ³digo"]||"").toString().trim();
Â  Â  Â  Â  const precioMinorista = (item["Precio Minorista"]||"0").toString().trim();
Â  Â  Â  Â  const precioMayorista = (item["Precio Mayorista"]||"0").toString().trim();
Â  Â  Â  Â  const imagen = (item["Imagen"]||"").trim();
Â  Â  Â  Â  // ðŸ’¡ LÃ­nea original modificada para usar solo el WhatsApp del vendedor final
Â  Â  Â  Â  // const whatsapp = (item["WhatsApp"]||"595986830888").toString().trim(); 
Â  Â  Â  Â  const card = document.createElement("div");
Â  Â  Â  Â  card.className = "card";
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  <img src="${imagen}" alt="${nombre}" loading="lazy"
Â  Â  Â  Â  Â  onerror="this.src='https://via.placeholder.com/250x200?text=Sin+imagen'" />
Â  Â  Â  Â  Â  <div class="info">
Â  Â  Â  Â  Â  Â  <h2>${nombre}</h2>
Â  Â  Â  Â  Â  Â  <p>${detalle}</p>
Â  Â  Â  Â  Â  Â  <p><strong>CÃ³digo:</strong> ${codigo}</p>
Â  Â  Â  Â  Â  Â  <div class="prices">
Â  Â  Â  Â  Â  Â  Â  <strong>Minorista:</strong> Gs. ${precioMinorista}<br>
Â  Â  Â  Â  Â  Â  Â  <strong>Mayorista:</strong> Gs. ${precioMayorista} (6+ unidades)
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  Â  <input type="number" value="1" min="1" id="qty-${codigo}" />
Â  Â  Â  Â  Â  Â  <button class="btn">Agregar al carrito</button>
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  const qtyInput = card.querySelector(`#qty-${codigo}`);
Â  Â  Â  Â  const btn = card.querySelector(".btn");
Â  Â  Â  Â  btn.addEventListener("click", e=>{
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  const qty = parseInt(qtyInput.value);
Â  Â  Â  Â  Â  const precioUnitario = obtenerPrecio(qty, precioMinorista, precioMayorista);
Â  Â  Â  Â  Â  const subtotal = precioUnitario * qty;
Â  Â  Â  Â  Â  const existente = carrito.find(p=>p.codigo===codigo); // Se eliminÃ³ la verificaciÃ³n de whatsapp
Â  Â  Â  Â  Â  if(existente){
Â  Â  Â  Â  Â  Â  existente.cantidad = qty;
Â  Â  Â  Â  Â  Â  existente.precioUnitario = precioUnitario;
Â  Â  Â  Â  Â  Â  existente.subtotal = subtotal;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ðŸ’¡ Se eliminÃ³ la variable whatsapp al pushear al carrito
Â  Â  Â  Â  Â  Â  carrito.push({nombre,codigo,cantidad:qty,precioUnitario,subtotal}); 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  btn.textContent = "Agregado âœ…";
Â  Â  Â  Â  Â  btn.classList.add("agregado");
Â  Â  Â  Â  Â  actualizarCarrito();
Â  Â  Â  Â  });
Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  });

Â  Â  Â  contenido.appendChild(grid);
Â  Â  Â  acordeon.appendChild(titulo);
Â  Â  Â  acordeon.appendChild(contenido);
Â  Â  Â  container.appendChild(acordeon);
Â  Â  Â  titulo.addEventListener("click",()=>{
Â  Â  Â  Â  const visible = contenido.style.display==="block";
Â  Â  Â  Â  document.querySelectorAll(".acordeon-contenido").forEach(c=>c.style.display="none");
Â  Â  Â  Â  document.querySelectorAll(".acordeon-titulo span").forEach(s=>s.textContent="+");
Â  Â  Â  Â  if(!visible){
Â  Â  Â  Â  Â  contenido.style.display="block";
Â  Â  Â  Â  Â  titulo.querySelector("span").textContent="âˆ’";
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });
Â  })
Â  .catch(err=>{
Â  Â  console.error("Error cargando productos:", err);
Â  Â  document.getElementById("loader-overlay").innerHTML="<p>Error al cargar los productos ðŸ˜¢</p>";
Â  });
</script>
</body>
</html>

